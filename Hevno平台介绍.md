# Hevno平台介绍

## 重要说明

首先需要注意，这是一个完全不同于酒馆的新平台。请不要将其视为酒馆的升级版。

这个平台要完成的任务在根本上远比酒馆复杂，所以其创作者使用门槛会更高，请耐心地看文档。

## 酒馆的工作模式回顾

让我们回顾一下在酒馆中我们是怎么工作的？

首先我们有一个**预设**。其中有破限词、文风要求、写作指导、思考链、小总结要求等大量条目。

然后我们有**世界书**，其中也有大量的条目。世界书的条目根据聊天记录激活后插入到预设的不同位置。

酒馆还为我们记录**聊天历史**，并将其插入预设的指定位置。

每当我们进行一次新的对话，酒馆为我们根据这些信息组装一个巨大无比的提示词，并将LLM的回复直接返回。

我们再通过正则匹配去除思维链、隐藏小总结，只提取正文。酒馆助手还会为我们取出其中的变量更新部分执行。

## 酒馆模式的致命问题

这样的工作模式存在一个致命的问题：我们对LLM的要求过于复杂。

### LLM在一次回复内要做的事情

1. 进行破限
2. 记住你要求的文风、不想要的表达（投石子、弓起等）
3. 记住所有角色和故事的设定
4. 执行你的思考链，包括场景规划、角色扮演、剧情推进等等
5. 生成正文
6. 生成小总结
7. 生成变量更新代码（MVU框架、表格插件）

这太复杂了。其中任何一步单独让LLM去做或许没问题，但是让LLM在一次回复内做这么多事情，LLM就会出错。所以我们遇到了很多问题。

### 具体问题分析

**缺乏检查能力**：很多错误比如掉标签、八国联军（LLM回复夹杂大量外文词汇）、生理知识错误、角色设定丢失等等，其实你把LLM生成的内容单独发给他让他检查，他是能看出来的。只是在一次回复内执行过于复杂，LLM无暇顾及这些细节。但是我们只有一次单独的LLM调用，所以LLM无法检查自己的错误。

**注意力不够用**：本质上是因为LLM的注意力不够用。相信很多人都知道预设的思维链不能过重。越是详细地在思维链里引导思考，LLM的注意力越多地被消耗在思考链上，而不是正文生成上，导致正文生成质量下降。

**系统功能局限**：更进一步地，这导致了我们的变量系统至今局限于简单的数值加减。我们能让LLM设计一把全新的武器加进我们的世界书里面吗？理论上用提示词模版和酒馆助手可以做到，但是实际上LLM给出的设计短小而无趣。这是因为在完成了那么多复杂的任务后，LLM已经没有足够的注意力去设计一个有趣的武器了。

## 解决方案：分步式LLM调用

### 基本思路

想象这样一个场景：

**步骤1：剧情规划**
我们制作一个特殊的预设，这个预设不要求LLM生成正文，而是要求LLM专门根据我们的要求生成思考链，且这个思考链只负责剧情规划和角色扮演。我们使用这个预设，加入我们的世界书和聊天记录进行一次LLM调用。这样我们得到了一个极其详细的下一步剧情概要。在这次调用中，LLM只需要专注于思考链的生成，他不需要关注文风、正文生成和总结等内容。

**步骤2：正文生成**
接下来我们准备第二个预设，这个预设不需要包含思考链等内容，而是有着详细的文风要求、描写范例等内容。我们将这个预设和上一步生成的剧情概要、世界书和聊天记录一起进行一次LLM调用。LLM在这次调用中只需要专注于根据上一步给出的剧情概要进行扩写，得到一个详细的正文。这次调用中LLM可以将全部的注意力都放在写作上。

**步骤3：轻型后处理**
最后我们准备一系列轻型预设：
- 专门的总结预设，用于对上一步给出的正文进行小结
- 专门的变量更新预设，用于检查上一步的剧情里是否有需要更新的变量，并生成相应的代码
- 专门的八股和八国联军修正预设，用于检查上一步的正文是否有八股和八国联军等问题，并进行修正

在正文生成后，我们可以同时启动这些轻型预设，分别对正文进行小结、变量更新和八股修正等操作。

而我们可以为每次LLM调用配置不同的模型。比如正文生成我们希望用pro模型，而总结就只需要flash模型了。

### 核心理念

本质上，我们当前的LLM调用是使用一个巨大的提示词囊括了所有的任务，这超出了LLM的注意力极限，导致我们每天都感觉LLM在流口水。

那么为什么我们不将这些任务拆分开来，分步进行呢？让一群哈基米（Gemini）来代替那个流口水的哈基米。

这就是这个新平台想要解决的事情。

## 更进一步的功能设想

### 真实角色扮演
我们能不能让预设中常见的"角色扮演"要求真的变成角色扮演？在剧情推动时，真的为剧情中的每个角色发起一次独立的LLM调用，让LLM真实地扮演这个角色思考自己会怎么做。这些调用可以是并行进行的，在完成后汇总到一起，再进行一个总剧情推进。

### 动态场景判断
又比如，先用一个快速的flash模型判断当前场景是战斗场景？NSFW场景？日常场景？还是其他场景？然后根据判断结果动态地选择不同的预设进行正文生成。

### 多候选生成与评选
甚至可以在生成正文时，并行地调用很多个LLM生成正文。在全部完成后输送给一个LLM进行点评，让他选出最好的正文。

还会有很多天马行空的想法。而为了实现这些想法，我们需要一个新平台。

## 新平台的特点

### 不同于酒馆的设计

**多个小预设代替单一预设**
这个平台里不会有一个预设栏，因为你会有很多个哈基米要管理，每个都需要一个小预设，而每个预设都只会负责一部分任务。比如一个哈基米只负责剧情规划，一个哈基米只负责正文生成，一个哈基米只负责总结和变量更新。

**差异化的世界书管理**
这个平台里不会只有一个世界书，因为不是每个哈基米都需要一个完整的世界书。比如剧情设计的哈基米不需要看文风指导，总结的哈基米不需要看角色设定。

**分层的聊天记录管理**
这个平台里不会有一个统一的聊天记录管理，比如负责剧情设计的哈基米需要看完整的聊天记录，而负责正文生成的哈基米只需要看最近几条聊天记录。

### 全新的数据系统

最重要的，这个平台需要一个全新的数据系统，一个涵盖了预设、世界书、聊天记录和变量更新的数据系统。只有这样，我们才能调度这么多的哈基米，让他们各司其职，分工合作。

## Hevno平台现状

为此我们编写了一个完整的新平台，Hevno。

这个平台目前具有很高的后端完成度，能够以流图的形式组织大量LLM的调用、在不同的LLM的prompt条目之间相互注入信息、随意地嵌入预设、世界书甚至代码执行片段。

简单来说，纯文字卡需要的一切基本已经就绪。上面所提到那些设想，都已经能实现了。

详细的后端介绍参考：https://github.com/Niurouxing/TheWanderingHevno/tree/main/backend

## 需要帮助的方面

但是我的能力已经达到了极限。

### 前端开发
我不是专业的前端开发，也对当前的前端卡工作方式不熟悉。我很难做出一个好用的前端界面来方便不具备代码能力的用户使用这个平台，也不知道如何为前端卡的作者提供他们想要的功能。

### 预设设计
我不擅长预设的设计。在这个系统中，大量的预设需要重新设计，拆分成很多个小预设，而不是一个大预设。我不清楚如何设计这些预设才能让LLM高效地工作。

### 故事创作
我不擅长写故事。我很难给出一个诱人的角色卡设计来吸引大家使用我的平台。

## 寻求合作

所以我需要大家的帮助。

任何形式的帮助都可以：
- 如果你是前端卡作者，告诉我你最希望酒馆加入什么功能
- 如果你是预设和卡作者，尝试用这个新平台创造新的工作流
- 如果你是插件作者，告诉我你希望这个平台提供什么样的API

随便告诉我什么都可以，哪怕是给出你天马行空的愿望，想多人联机、想多人共享文风库等等都可以实现。
